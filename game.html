<!DOCTYPE html>
<html>
<head>
  <title>Canabalt Clone</title>
  <style>
    body {
      background: #4D4D59;
      margin: 0;
      padding: 0;
      padding-top: 45px;
    }

    #game {
      border: 6px solid #35353D;
      border-right-color: #45454F;
      border-bottom-color: #646A7D;
      margin: 0 auto;
      height: 324px;
      width: 964px;
      position: relative;
      background: #B0B0BF;
      overflow: hidden;
    }

    #game .building {
      position: absolute;
      bottom: 0;
      background: url('building-top.png') left top repeat-x, url('windows.png') left 12px;
      z-index: 3;
    }

    #game .runner {
      position: absolute;
      height: 30px;
      width: 15px;
      background: red;
      z-index: 5;
    }

    #game .paralaxbg1 {
      position: absolute;
      left: 0;
      right: 0;
      top: 0;
      bottom: 0;
      background: url('paralax-bg-1.png') 0 50px repeat-x;
      z-index: 2;
    }
  </style>
  <script type="text/javascript">
    if (!Array.prototype.forEach) {
      Array.prototype.forEach = function(f) {
        for (var i = 0; i < this.length; ++i) {
          f(this[i]);
        }
      }
    }

    Canabalt = function(container, options) {
      this.options = options || {};
      this.container = container;
      this.viewportWidth = this.container.offsetWidth;
      this.buildings = [];

      // Milliseconds between frames
      this.mbf = 1000 / this.readOption('fps');

      this.initialize();
    };

    // Cap game at 90 cycles per second
    // FPS can't get higher than this
    Canabalt.CYCLES_PER_SECOND = 90;
    
    // Map keys bound to jump action
    Canabalt.BIND_JUMP_KEYS = {'88': true, '67': true, '32': true}; // X, C, spacebar

    Canabalt.PARALAX_BG_1_TOP_OFFSET = '100px';
    Canabalt.PARALAX_BG_1_SPEED = 0.3;
    Canabalt.PARALAX_BG_2_SPEED = 0.1;
    Canabalt.PARALAX_FG_SPEED = 3;

    Canabalt.defaultOptions = {
      fps: 50,
      initialSpeed: 0.3,
      acceleration: 0.0001,
      jumpImpulse: 5,
      gravity: 0.15,
      leftOffset: 50
    };

    Canabalt.prototype.readOption = function(option) {
      return this.options[option] || Canabalt.defaultOptions[option];
    };

    Canabalt.prototype.initialize = function() {
      // Reset speed
      this.speed = this.readOption('initialSpeed');

      // Runner variables
      this.airborne = false;
      this.jumping = false;
      this.ySpeed = 0;
      this.y = 0;

      // Copy some options to object space for quicker access
      this.acceleration = this.readOption('acceleration');
      this.jumpImpulse = this.readOption('jumpImpulse');
      this.gravity = this.readOption('gravity');
      this.leftOffset = this.readOption('leftOffset');

      // Pointer to the building the runner is currently "stepping" on
      this.currentBuilding = null;

      // Create runner DIV
      if (!this.runner) {
        this.runner = document.createElement('div');
        this.runner.className = 'runner';
        this.runner.style.left = String(this.leftOffset) + 'px';
        this.container.appendChild(this.runner);
      }

      // First paralax background
      if (!this.paralaxBg1) {
        this.paralaxBg1 = document.createElement('div');
        this.paralaxBg1.className = 'paralaxbg1';
        this.container.appendChild(this.paralaxBg1);
      }

      this.paralaxBg1Offset = 0;

      // Remove all buildings
      for (var i = 0; i < this.buildings.length; ++i) this.removeBuilding();

      // Place the first building
      this.addBuilding(new Canabalt.Building(this));

      return this;
    };

    Canabalt.prototype.start = function() {
      if (!this.interval) {
        // Initialize cycle clock and timer
        this.lastCycle = Date.now();
        this.elapsed = 0;

        this.startInputCapture();

        // Create game interval
        var me = this;
        this.interval = setInterval(function() { me.cycle(); }, 1000 / Canabalt.CYCLES_PER_SECOND);
      }
      return this;
    };

    Canabalt.prototype.stop = function() {
      if (this.interval) {
        this.stopInputCapture();

        // Stop game interval
        clearInterval(this.interval);
        delete this.interval;
      }
      return this;
    };

    Canabalt.prototype.addBuilding = function(building) {
      this.buildings.unshift(building);
      this.container.appendChild(building.element);
    };

    Canabalt.prototype.removeBuilding = function() {
      var building = this.buildings.pop();
      this.container.removeChild(building.element);
    };

    Canabalt.prototype.startInputCapture = function() {
      var me = this;

      this.oldOnKeyDown = document.onkeydown;
      this.oldOnKeyUp = document.onkeyup;

      // Use DOM-0-style event listener registration
      // for easier cross-browser compatibility
      // No need for anything fancy anyway
      
      document.onkeydown = function(event) {
        if (Canabalt.BIND_JUMP_KEYS[String(event.keyCode)]) {
          me.startJump();
        }
      };

      document.onkeyup = function(event) {
        if (Canabalt.BIND_JUMP_KEYS[String(event.keyCode)]) {
          me.endJump();
        }
      };
    };

    Canabalt.prototype.stopInputCapture = function() {
      document.onkeydown = this.oldOnKeyDown;
      document.onkeyup = this.oldOnKeyUp;
    };

    Canabalt.prototype.startJump = function() {
      if (!this.airborne && !this.jumping) {
        this.airborne = true;
        this.jumping = true;
        this.ySpeed = this.jumpImpulse;
      }
    };

    Canabalt.prototype.endJump = function() {
      if (this.airborne && this.jumping) {
        this.jumping = false;
        if (this.ySpeed > 0) this.ySpeed = 0;
      } else if (this.jumping) {
        this.jumping = false;
      }
    };

    Canabalt.prototype.draw = function() {
      // Draw buildings
      for (var i = 0; i < this.buildings.length; ++i) {
        this.buildings[i].draw();
      }

      // Draw runner
      this.runner.style.bottom = String(Math.round(this.y)) + 'px';

      // Draw paralax
      this.paralaxBg1.style.backgroundPosition = String(Math.round(this.paralaxBg1Offset)) + 'px ' + Canabalt.PARALAX_BG_1_TOP_OFFSET;
    };

    Canabalt.prototype.scroll = function(distance) {
      for (var i = 0; i < this.buildings.length; ++i) {
        this.buildings[i].move(distance);
      }
    };

    Canabalt.prototype.cycle = function() {
      // Calculate time elapsed since last game cycle
      var elapsed = Date.now() - this.lastCycle;

      // Keep track of time elapsed since last frame
      this.elapsed += elapsed;

      // Calculate how much we moved this cycle
      var distance = Math.round(elapsed * this.speed);

      // Increase speed
      this.speed += this.acceleration;

      // Check jump
      if (this.airborne) {
        this.y += this.ySpeed;
        this.ySpeed -= this.gravity;

        //var currentBuilding = this.currentBuilding();
        var h = this.currentBuilding ? this.currentBuilding.height : 0;

        if (this.y <= h) {
          this.y = h;
          this.ySpeed = 0;
          this.airborne = false;
        }
      }

      // Move buildings
      this.scroll(distance);

      // Move paralax
      this.paralaxBg1Offset -= distance * Canabalt.PARALAX_BG_1_SPEED;

      // Check if we need to redraw
      if (this.elapsed > this.mbf) {
        this.elapsed = 0;
        this.draw();
      }

      this.lastCycle = Date.now();
    };

    Canabalt.Building = function(game, options) {
      this.game = game;

      this.type = Canabalt.Building.TYPE_NORMAL;

      this.width = 300 + Math.random() * 500;
      this.height = 30 + Math.random() * 100;
      this.gap = 100;
      this.totalWidth = this.width + this.gap;

      this.left = this.game.viewportWidth;

      this.endReached = false;
      this.expired = false;

      this.in = false;
      this.out = false;

      this.element = document.createElement('div');
      this.element.className = 'building';
      this.element.style.height = String(this.height) + 'px';
      this.element.style.width = String(this.width) + 'px';

      this.draw();
    };

    Canabalt.Building.TYPE_NORMAL= 1;
    Canabalt.Building.TYPE_CRANE = 2;
    Canabalt.Building.TYPE_DEMOLITION = 3;
    Canabalt.Building.TYPE_INDOORS = 4;

    Canabalt.Building.prototype.move = function(distance) {
      this.left -= distance;

      // Check if this is now the current building
      if (this.in) {
        if (!this.out && this.left + this.width < this.game.leftOffset) {
          this.game.currentBuilding = null;
          this.game.airborne = true;
          this.out = true;
        }
      } else if (this.left <= this.game.leftOffset) {
        this.game.currentBuilding = this;
        this.in = true;
      }

      // Check if the end of the building + gap was reached and call
      // an appropiate action (spawn a new building?)
      if (!this.endReached && (this.left + this.totalWidth <= this.game.viewportWidth)) {
        this.game.addBuilding(new Canabalt.Building(this.game));
        this.endReached = true;
      }

      // If the building leaves the left side of the screen then
      // it has expired and has to be removed
      if (!this.expired && (this.totalWidth + this.left <= 0)) {
        this.game.removeBuilding();
        this.expired = true;
      }

      return this;
    };

    Canabalt.Building.prototype.draw = function() {
      if (!this.expired) {
        this.element.style.left = String(this.left) + 'px';
      }
      return this;
    };
  </script>
</head>
<body>
  <div id="game">
  </div>
  <script type="text/javascript">
    var game = new Canabalt(document.getElementById('game'), {fps: 40}).start();
  </script>
</body>
</html>
